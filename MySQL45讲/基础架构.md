### MySQL基础架构

总体来说，MySQL可以分为Server层和存储引擎层两部分，Server层包括：

+ 连接器
+ 查询缓存
+ 分析器
+ 优化器
+ 执行器等

覆盖MySQL种大部分核心功能，以及所有内置函数，所有跨存储引擎的功能都在这一层实现，比如存储过程，触发器，视图等等。

存储引擎层负责存储和提取，其架构模式是插件式的。支持InnoDB，MylSAM，Memory等等，最常用的是InnoDB，从MySQL5.5.5版本成为默认的存储引擎，不同存储引擎的表数据存取方式不同，不同的存储引擎共用一个Server层。

### 连接器

连接器负责和客户端建立连接，获取权限，维持和管理连接，连接器和客户端之间的连接是TCP连接。

客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数wait_timeout控制的，默认值是8小时。

数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。

### 长连接

### 短链接

### 查询缓存

**MySQL在拿到一个查询请求之后，会先检查缓存，查看之前是不是有执行这条语句，之前执行过的语句及其结果可能会以key-value对的形式**，被直接缓存在内存中。key是查询的语句，value是查询的结果。如果查询能够直接在这个缓存中找到key，就会直接返回给客户端。

**如果没有在缓存中，就会执行之后的阶段，然后把查询结果就会存入缓存中**，但是大多数情况不建议使用查询缓存。

因为查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空，查询缓存的命中率会非常低。除非你的业务就是有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。

### 分析器

如果没有在查询缓存就会来到这一步，这里是主要关心两个部分**词法分析器和语法分析器**，MySQL会提取查询语句中的关键字(例如select)和非关键字(例如表名字段名)。这一段主要是词法分析器负责的。

语法分析器根据之前词法分析器的结果，按照语法规则来判断SQL语句是否合法。

### 优化器

结果分析器这一步，MySQL就晓得要做什么了，但是在执行之前还需要经过优化器的处理，**优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。**

### 执行器

MySQL通过分析器知道做什么，通过优化器知道怎么做，到了执行器就开始执行语句，在开始执行之前，要先判断一下有没有对这个表执行查询的权限，如果没有，就会返回没有权限的错误。

如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。

### SQL执行过程

